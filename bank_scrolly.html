<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bank Approval Rates Scrollytelling</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Fira Sans', 'Droid Sans', 'Helvetica Neue', Arial, sans-serif; margin: 0; }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1 { margin: 0 0 12px; font-size: 28px; }
    .note { color: #555; margin-bottom: 16px; }

    .scrolly { display: grid; grid-template-columns: 1fr 460px; gap: 16px; align-items: start; }
    .sticky { position: sticky; top: 0; height: 80vh; min-height: 520px; border: 1px solid #eee; border-radius: 0; padding: 8px; background: #fff; }
    #chart { width: 100%; height: 100%; }

    .steps { display: flex; flex-direction: column; gap: 10px; padding-right: 4px; }
    .step { background: #fff; border: 1px solid #cfcfcf; border-radius: 0; padding: 12px 16px; box-shadow: 0 1px 0 rgba(0,0,0,0.02); display: block; transition: border-color 200ms ease-out; outline: none; margin: 0 0 80vh 0; }
    .steps .step:last-child { margin-bottom: 100vh; }
    .step h2 { margin: 0 0 8px; font-size: 22px; }
    .step p { margin: 0; color: #444; line-height: 1.45; }
    .step.active { border-color: #b3b3b3; background: #fff; }
    .step:not(.active) { border-color: transparent; background: transparent; }
    .step:not(.active) h2, .step:not(.active) p { visibility: hidden; }
    .step:focus, .step:focus-visible { outline: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="scrolly">
      <div class="sticky">
        <div id="chart"></div>
      </div>

      <div class="steps">
        <div class="step" data-bank="JPMorgan Chase">
          <h2>JPMorgan Chase</h2>
          <p>From 2018 to 2024, JPMorgan’s mortgage‑approval gap between Black and White borrowers hovered around six percentage points.</p>
        </div>
        <div class="step" data-bank="Bank of America">
          <h2>Bank of America</h2>
          <p>Bank of America posted the smallest gap, about two points, but even its advantage narrowed in 2022.</p>
        </div>
        <div class="step" data-bank="Wells Fargo">
          <h2>Wells Fargo</h2>
          <p>Wells Fargo’s gap remained in double digits, narrowing only after it announced in early 2023 that it would reduce general mortgage lending and focus on existing customers and minority communities.
         </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const colors = { White: '#1f77b4', Black: '#ff7f0e' };

    async function loadData() {
      const res = await fetch('bank_race_summary.csv');
      const text = await res.text();
      const lines = text.trim().split('\n');
      const rows = lines.slice(1).map(l => l.split(','));
      const data = rows.map(cols => ({ year: +cols[0], bank: cols[1], race: cols[2], total: +cols[3], approved: +cols[4], rate: +cols[5] }));
      return data.filter(d => d.year >= 2018 && d.year <= 2024);
    }

    function buildGapArea(years, whiteRates, blackRates) {
      const upper = years.map((_, i) => Math.max(whiteRates[i], blackRates[i]));
      const lower = years.map((_, i) => Math.min(whiteRates[i], blackRates[i]));
      return {
        x: years.concat(years.slice().reverse()),
        y: upper.concat(lower.slice().reverse()),
        type: 'scatter',
        mode: 'lines',
        line: { width: 0 },
        fill: 'toself',
        fillcolor: 'rgba(255, 165, 0, 0.25)',
        hoverinfo: 'skip',
        showlegend: false
      };
    }

    function buildHoverTexts(years, wRates, bRates) {
      return years.map((yr, i) => {
        const w = wRates[i];
        const b = bRates[i];
        const gap = (w - b) * 100;
        const sign = gap >= 0 ? '+' : '';
        return `<span style="color:${colors.White}">White: ${(w*100).toFixed(1)}%</span><br>` +
               `<span style="color:${colors.Black}">Black: ${(b*100).toFixed(1)}%</span><br>` +
               `<span style="color:#000">Gap: ${sign}${gap.toFixed(1)}%</span>`;
      });
    }

    function makeFigureForBank(data, bank) {
      const subset = data.filter(d => d.bank === bank && (d.race === 'White' || d.race === 'Black'));
      const years = [...new Set(subset.map(d => d.year))].sort((a,b)=>a-b);
      const wRates = years.map(y => (subset.find(d => d.year === y && d.race === 'White')||{}).rate ?? null);
      const bRates = years.map(y => (subset.find(d => d.year === y && d.race === 'Black')||{}).rate ?? null);

      const traces = [];
      traces.push(buildGapArea(years, wRates, bRates));

      traces.push({ x: years, y: wRates, type: 'scatter', mode: 'lines+markers', name: 'White',
        line: { color: colors.White, width: 3 }, marker: { color: colors.White, size: 8 }, hoverinfo: 'skip' });
      traces.push({ x: years, y: bRates, type: 'scatter', mode: 'lines+markers', name: 'Black',
        line: { color: colors.Black, width: 3 }, marker: { color: colors.Black, size: 8 }, hoverinfo: 'skip' });

      const mid = years.map((_, i) => (wRates[i] + bRates[i]) / 2);
      const texts = buildHoverTexts(years, wRates, bRates);
      traces.push({ x: years, y: mid, type: 'scatter', mode: 'markers', showlegend: false,
        marker: { size: 12, opacity: 0 }, text: texts, hovertemplate: '%{text}<extra></extra>' });

      const layout = {
        title: { text: bank, x: 0.5, font: { size: 18 } },
        xaxis: { tickmode: 'linear', dtick: 1, range: [2017.5, 2024.5], gridcolor: '#f1f1f1', showspikes: false },
        yaxis: { tickformat: '.0%', range: [0.6, 1.0], gridcolor: '#f1f1f1', showspikes: false },
        margin: { l: 60, r: 40, t: 40, b: 48 },
        showlegend: false,
        hovermode: 'closest',
        hoverlabel: { bgcolor: 'white', bordercolor: '#cfcfcf', font: { color: '#222' } }
      };

      const config = { displayModeBar: false, responsive: true };
      return { traces, layout, config };
    }

    async function init() {
      const data = await loadData();
      const steps = Array.from(document.querySelectorAll('.step'));

      const render = (bank) => {
        const fig = makeFigureForBank(data, bank);
        Plotly.react('chart', fig.traces, fig.layout, fig.config);
      };

      steps[0].classList.add('active');
      render(steps[0].getAttribute('data-bank'));

      const io = new IntersectionObserver((entries) => {
        let best = null; let bestRatio = 0;
        entries.forEach(entry => {
          const el = entry.target;
          if (entry.isIntersecting && entry.intersectionRatio > bestRatio) { best = el; bestRatio = entry.intersectionRatio; }
        });
        if (best) {
          steps.forEach(s => s.classList.toggle('active', s === best));
          render(best.getAttribute('data-bank'));
        }
      }, { root: null, rootMargin: '0px', threshold: [0.65, 0.85, 1] });

      steps.forEach(step => io.observe(step));
    }

    init();
  </script>
</body>
</html>
